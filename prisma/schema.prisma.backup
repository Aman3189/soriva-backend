// prisma/schema.prisma
// SORIVA Backend - Production Schema v2.0
// Supports: Chat, Studio, Lumos, Persona + Billing System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER MODEL
// ==========================================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String?
  name      String?
  avatar    String?
  
  // OAuth fields
  googleId     String?  @unique
  googleEmail  String?
  googleAvatar String?
  authProvider String   @default("email")
  
  // Plan & Subscription
  subscriptionPlan String   @default("vibe_free")
  planStatus       String   @default("active")
  planStartDate    DateTime @default(now())
  planEndDate      DateTime?
  
  // Trial tracking
  trialUsed        Boolean  @default(false)
  trialStartDate   DateTime?
  trialEndDate     DateTime?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?
  
  // Relations
  subscriptions Subscription[]
  usages        Usage[]
  boosters      Booster[]
  credits       Credit[]
  transactions  Transaction[]
  chatSessions  ChatSession[]
  messages      Message[]
  jobs          Job[]
  fileUploads   FileUpload[]

  @@index([email])
  @@index([googleId])
  @@index([subscriptionPlan])
  @@index([planStatus])
  @@map("users")
}

// ==========================================
// SUBSCRIPTION MODEL
// ==========================================
model Subscription {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Plan details
  planName     String   // vibe_free, spark_pro, apex_ultra, etc
  planPrice    Int      // Price in paise (₹0 = 0, ₹249 = 24900)
  status       String   @default("active") // active, expired, cancelled, pending
  
  // Billing cycle
  startDate    DateTime @default(now())
  endDate      DateTime
  autoRenew    Boolean  @default(true)
  
  // Trial info
  isTrial      Boolean  @default(false)
  trialDays    Int?
  
  // Payment gateway (generic - supports any provider)
  paymentGateway        String?  // cashfree, razorpay, stripe, phonepe
  gatewaySubscriptionId String?  @unique
  gatewayCustomerId     String?
  gatewayMetadata       Json?
  
  // Cancellation
  cancelledAt  DateTime?
  cancelReason String?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([planName])
  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

// ==========================================
// USAGE MODEL (Words/Credits Tracking)
// ==========================================
model Usage {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  planName       String
  
  // Word limits
  wordsUsed      Int      @default(0)
  dailyWordsUsed Int      @default(0)
  monthlyLimit   Int
  dailyLimit     Int
  
  // Reset tracking
  lastDailyReset   DateTime @default(now())
  lastMonthlyReset DateTime @default(now())
  
  // Period
  month    Int
  year     Int
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, month, year])
  @@index([userId])
  @@index([planName])
  @@map("usages")
}

// ==========================================
// BOOSTER MODEL (Add-ons)
// ==========================================
model Booster {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Booster details
  boosterType  String   // daily_3x, weekly_3x
  boosterPrice Int      // Price in paise
  multiplier   Int      @default(3)
  
  status       String   @default("active") // active, expired, used
  
  // Lifecycle
  activatedAt  DateTime @default(now())
  expiresAt    DateTime
  cooldownEnd  DateTime?
  
  // Usage tracking
  wordsUsed    Int      @default(0)
  wordsLimit   Int
  
  // Payment (generic)
  paymentGateway    String?
  gatewayPaymentId  String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("boosters")
}

// ==========================================
// CREDIT MODEL (Alternative to words)
// ==========================================
model Credit {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  totalCredits     Int      @default(0)
  usedCredits      Int      @default(0)
  remainingCredits Int      @default(0)
  
  planName         String
  
  month            Int
  year             Int
  lastReset        DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, month, year])
  @@index([userId])
  @@map("credits")
}

// ==========================================
// TRANSACTION MODEL (Payment History)
// ==========================================
model Transaction {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Transaction details
  type         String   // subscription, booster, credit_purchase, refund
  amount       Int      // Amount in paise
  currency     String   @default("INR")
  status       String   // success, failed, pending, refunded
  
  // Related entities
  planName     String?
  boosterType  String?
  creditsAdded Int?
  
  // Payment gateway (generic)
  paymentGateway     String?  // cashfree, razorpay, stripe, phonepe
  gatewayPaymentId   String?  @unique
  gatewayOrderId     String?
  gatewaySignature   String?
  gatewayMetadata    Json?
  
  // Metadata
  description  String?
  receiptUrl   String?
  refundReason String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([gatewayPaymentId])
  @@map("transactions")
}

// ==========================================
// CHAT SESSION MODEL (Conversations)
// ==========================================
model ChatSession {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title     String   @default("New Chat")
  
  // AI settings
  aiModel   String   @default("claude-sonnet-4")
  brainMode String?  // creative, balanced, analytical
  
  // Session stats
  messageCount Int     @default(0)
  totalTokens  Int     @default(0)
  
  // Status
  isActive     Boolean @default(true)
  isPinned     Boolean @default(false)
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastMessageAt DateTime @default(now())
  
  // Relations
  messages Message[]
  
  @@index([userId])
  @@index([isActive])
  @@index([lastMessageAt])
  @@map("chat_sessions")
}

// ==========================================
// MESSAGE MODEL (Chat Messages)
// ==========================================
model Message {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Message content
  role      String   // user, assistant, system
  content   String   @db.Text
  
  // AI metadata
  aiModel   String?
  tokens    Int?
  
  // Attachments
  hasAttachments Boolean @default(false)
  attachmentIds  String[] // References to FileUpload ids
  
  // Feedback
  rating    Int?     // 1-5 stars
  feedback  String?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("messages")
}

// ==========================================
// JOB MODEL (AI Tasks - Studio/Lumos/Persona)
// ==========================================
model Job {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Job classification
  category  String   // studio, lumos, persona
  feature   String   // image_gen, translator, fashion_advisor, etc
  
  // Job details
  status    String   @default("pending") // pending, processing, completed, failed
  priority  Int      @default(1)
  
  // Input/Output
  inputData  Json     // User's input parameters
  outputData Json?    // AI's response/result
  
  // AI model used
  aiModel    String?
  aiProvider String?  // anthropic, google, openai
  
  // Resource tracking
  creditsUsed   Int?
  tokensUsed    Int?
  processingTime Int? // in milliseconds
  
  // File associations
  inputFileIds  String[]  // References to FileUpload ids
  outputFileIds String[]  // Generated files
  
  // Error handling
  errorMessage  String?
  retryCount    Int      @default(0)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  
  @@index([userId])
  @@index([category])
  @@index([feature])
  @@index([status])
  @@index([createdAt])
  @@map("jobs")
}

// ==========================================
// FILE UPLOAD MODEL (Media Storage)
// ==========================================
model FileUpload {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // File details
  filename     String
  originalName String
  mimeType     String
  fileSize     Int      // in bytes
  
  // Storage
  storageProvider String  @default("cloudinary") // cloudinary, s3, local
  storageUrl      String  // Full URL to file
  storageKey      String? // Provider's key/identifier
  thumbnailUrl    String?
  
  // File metadata
  width       Int?
  height      Int?
  duration    Int?     // For videos/audio (in seconds)
  
  // Classification
  category    String   // image, video, audio, document, other
  purpose     String?  // chat_attachment, studio_input, profile_avatar
  
  // Status
  isPublic    Boolean  @default(false)
  isProcessed Boolean  @default(true)
  
  // Timestamps
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
  
  @@index([userId])
  @@index([category])
  @@index([purpose])
  @@index([createdAt])
  @@map("file_uploads")
}