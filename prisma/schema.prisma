generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model UserUsage {
  id                 String    @id @default(cuid())
  userId             String    @unique
  tokensUsedMonthly  Int       @default(0)
  tokensUsedDaily    Int       @default(0)
  requestsThisMinute Int       @default(0)
  requestsThisHour   Int       @default(0)
  voiceMinutesUsed   Float     @default(0)
  monthlyResetAt     DateTime
  dailyResetAt       DateTime
  minuteResetAt      DateTime
  hourResetAt        DateTime
  lastRequestAt      DateTime  @default(now())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  extensionShownAt   DateTime?
  planName           String    @default("STARTER")
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id                          String                      @id @default(uuid())
  email                       String                      @unique
  password                    String?
  name                        String?
  googleId                    String?                     @unique
  googleEmail                 String?
  googleAvatar                String?
  authProvider                String                      @default("email")
  createdAt                   DateTime                    @default(now())
  updatedAt                   DateTime                    @updatedAt
  planEndDate                 DateTime?
  planStartDate               DateTime                    @default(now())
  avatar                      String?
  lastLoginAt                 DateTime?
  trialEndDate                DateTime?
  trialStartDate              DateTime?
  trialUsed                   Boolean                     @default(false)
  documentWordsUsed           Int                         @default(0)
  jailbreakAttempts           Int                         @default(0)
  lastSuspiciousActivity      DateTime?
  suspiciousActivityCount     Int                         @default(0)
  trialExtended               Boolean                     @default(false)
  averageSessionDuration      Int?
  lastGreetingAt              DateTime?
  lastSeenAt                  DateTime?
  loginPattern                Json?
  memoryDays                  Int                         @default(5)
  preferredTimeSlots          String[]                    @default([])
  responseDelay               Float                       @default(5.0)
  sessionCount                Int                         @default(0)
  gender                      String?                     @default("other")
  cooldownPurchasesThisPeriod Int                         @default(0)
  cooldownResetDate           DateTime?
  lastCooldownPurchaseAt      DateTime?
  trialDaysUsed               Int                         @default(0)
  planStatus                  PlanStatus                  @default(ACTIVE)
  securityStatus              SecurityStatus              @default(TRUSTED)
  activityTrend               ActivityTrend               @default(NEW)
  planType                    PlanType                    @default(STARTER)
  region                      Region                      @default(IN)
  currency                    Currency                    @default(INR)
  country                     String?                     @default("IN")
  detectedCountry             String?
  countryName                 String?
  timezone                    String?
  defaultAgeGroup             AgeGroup?                   @default(NOT_SPECIFIED)
  defaultGender               Gender?                     @default(NOT_SPECIFIED)
  githubId                    String?                     @unique
  accidentalBoosterRefunds    Int                         @default(0)
  accountFlagged              Boolean                     @default(false)
  deviceFingerprint           String?
  emailVerified               Boolean                     @default(false)
  flaggedReason               String?
  ipAddressHash               String?
  lastLoginIP                 String?
  lastRefundAt                DateTime?
  mobileNumber                String?
  mobileVerified              Boolean                     @default(false)
  refundCount                 Int                         @default(0)
  refundsThisYear             Int                         @default(0)
  homeCity                    String?                     @db.VarChar(255)
  homeState                   String?                     @db.VarChar(255)
  homeCountry                 String?                     @db.VarChar(255)
  homeCountryCode             String?                     @db.VarChar(10)
  homeLatitude                Float?
  homeLongitude               Float?
  homeLocationSetAt           DateTime?                   @db.Timestamp(6)
  currentCity                 String?                     @db.VarChar(255)
  currentState                String?                     @db.VarChar(255)
  currentCountry              String?                     @db.VarChar(255)
  currentCountryCode          String?                     @db.VarChar(10)
  currentLatitude             Float?
  currentLongitude            Float?
  currentLocationUpdatedAt    DateTime?                   @db.Timestamp(6)
  locationPermissionGranted   Boolean?                    @default(false)
  locationPermissionAskedAt   DateTime?                   @db.Timestamp(6)
  usages                      Usage?
  modelUsage                  UserModelUsage[]
  usage                       UserUsage?
  boosters                    Booster[]
  chatSessions                ChatSession[]
  conversationMessages        ConversationMessage[]
  documentChunks              DocumentChunk[]
  documentEmbeddings          DocumentEmbedding[]
  documentUsage               DocumentUsage?              @relation("UserDocumentUsage")
  documentOperations          DocumentOperation[]         @relation("UserDocumentOperations")
  documents                   Document[]
  exportLogs                  ExportLog[]
  fileUploads                 FileUpload[]
  forges                      Forge[]
  healthChats                 HealthChat[]
  healthFamilyMembers         HealthFamilyMember[]
  healthReminders             HealthReminder[]
  healthReports               HealthReport[]
  healthSubscription          HealthSubscription?
  healthUsage                 HealthUsage[]
  imageGenerations            ImageGeneration[]
  imageUsage                  ImageUsage?
  messages                    Message[]
  personalizationSuggestions  PersonalizationSuggestion[]
  queryLogs                   QueryLog[]
  securityLogs                SecurityLog[]
  signupLogs                  SignupLog[]
  smartDocsBoosterPurchases   SmartDocsBoosterPurchase[]
  smartDocsCreditLogs         SmartDocsCreditLog[]
  smartDocsCredit             SmartDocsCredit?
  subscriptions               Subscription[]
  transactions                Transaction[]
  usageAudits                 UsageAudit[]
  workspaceFreeQuota          WorkspaceFreeQuota?
  workspaceGenerations        WorkspaceGeneration[]
  conversationMemories        ConversationMemory[]

  @@index([email])
  @@index([googleId])
  @@index([planStatus])
  @@index([securityStatus])
  @@index([lastSeenAt])
  @@index([activityTrend])
  @@index([sessionCount])
  @@index([planType])
  @@index([cooldownResetDate])
  @@index([region])
  @@index([currency])
  @@index([country])
  @@index([defaultGender])
  @@index([defaultAgeGroup])
  @@index([deviceFingerprint])
  @@index([ipAddressHash])
  @@index([emailVerified])
  @@index([mobileVerified])
  @@index([accountFlagged])
  @@map("users")
}

model BlockedDevice {
  id          String   @id @default(cuid())
  fingerprint String   @unique
  reason      String
  blockedBy   String
  blockedAt   DateTime @default(now())

  @@index([fingerprint])
  @@map("blocked_devices")
}

model SignupLog {
  id                String   @id @default(cuid())
  userId            String
  deviceFingerprint String?
  ipAddressHash     String?
  userAgent         String?
  screenResolution  String?
  timezone          String?
  platform          String?
  createdAt         DateTime @default(now())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deviceFingerprint])
  @@index([ipAddressHash])
  @@map("signup_logs")
}



model SystemSettings {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  category    String
  description String?
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model HealthSubscription {
  id                    String                   @id @default(cuid())
  userId                String                   @unique
  plan                  HealthPlan               @default(FREE)
  status                HealthSubscriptionStatus @default(ACTIVE)
  price                 Int                      @default(0)
  currency              Currency                 @default(INR)
  region                Region                   @default(IN)
  startDate             DateTime                 @default(now())
  endDate               DateTime?
  maxMembers            Int                      @default(1)
  paymentGateway        String?
  gatewaySubscriptionId String?                  @unique
  gatewayCustomerId     String?
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  familyMembers         HealthFamilyMember[]
  user                  User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([plan])
  @@map("health_subscriptions")
}

model HealthFamilyMember {
  id             String             @id @default(cuid())
  userId         String
  subscriptionId String
  name           String
  relation       String
  dateOfBirth    DateTime?
  gender         String?
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  chats          HealthChat[]
  subscription   HealthSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  reports        HealthReport[]

  @@index([userId])
  @@index([subscriptionId])
  @@map("health_family_members")
}

model HealthReport {
  id             String              @id @default(cuid())
  userId         String
  familyMemberId String?
  title          String
  reportType     ReportType          @default(OTHER)
  reportDate     DateTime            @default(now())
  labName        String?
  doctorName     String?
  fileUrl        String
  filePublicId   String?
  fileSize       Int
  mimeType       String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  extractedText  String?
  fileName       String
  isArchived     Boolean             @default(false)
  pageCount      Int                 @default(1)
  tags           String[]            @default([])
  userNotes      String?
  reminders      HealthReminder[]
  familyMember   HealthFamilyMember? @relation(fields: [familyMemberId], references: [id])
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([familyMemberId])
  @@index([reportType])
  @@index([reportDate])
  @@index([createdAt])
  @@map("health_reports")
}

model HealthChat {
  id                 String              @id @default(cuid())
  userId             String
  familyMemberId     String?
  sessionId          String              @default(cuid())
  role               String
  content            String
  tokensUsed         Int?
  createdAt          DateTime            @default(now())
  referencedReportId String?
  familyMember       HealthFamilyMember? @relation(fields: [familyMemberId], references: [id])
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([familyMemberId])
  @@index([createdAt])
  @@map("health_chats")
}

model HealthUsage {
  id              String   @id @default(cuid())
  userId          String
  month           Int
  year            Int
  comparisonsUsed Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  pagesUploaded   Int      @default(0)
  tokensUsed      Int      @default(0)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@index([userId])
  @@index([month, year])
  @@map("health_usage")
}

model HealthReminder {
  id           String        @id @default(cuid())
  userId       String
  reportId     String?
  title        String
  notes        String?
  reminderDate DateTime
  isCompleted  Boolean       @default(false)
  completedAt  DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  report       HealthReport? @relation(fields: [reportId], references: [id])
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([reportId])
  @@index([reminderDate])
  @@index([isCompleted])
  @@map("health_reminders")
}

model Subscription {
  id                    String       @id @default(uuid())
  userId                String
  planName              String
  planPrice             Int
  startDate             DateTime     @default(now())
  endDate               DateTime
  autoRenew             Boolean      @default(true)
  paymentGateway        String?
  gatewaySubscriptionId String?      @unique
  gatewayCustomerId     String?
  gatewayMetadata       Json?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  cancelReason          String?
  cancelledAt           DateTime?
  isTrial               Boolean      @default(false)
  trialDays             Int?         @default(14)
  status                PlanStatus   @default(ACTIVE)
  currency              Currency     @default(INR)
  region                Region       @default(IN)
  bonusTokensLimit      Int          @default(0)
  bonusTokensUsed       Int          @default(0)
  lastResetAt           DateTime     @default(now())
  monthlyTokens         Int          @default(0)
  tokensUsed            Int          @default(0)
  usageResetDay         Int          @default(1)
  billingCycle          BillingCycle @default(MONTHLY)
  user                  User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([planName])
  @@index([status])
  @@index([endDate])
  @@index([currency])
  @@index([region])
  @@index([lastResetAt])
  @@index([billingCycle])
  @@map("subscriptions")
}

model Usage {
  id                         String    @id @default(cuid())
  userId                     String    @unique
  planName                   String
  wordsUsed                  Int       @default(0)
  dailyWordsUsed             Int       @default(0)
  remainingWords             Int       @default(0)
  bonusWords                 Int       @default(0)
  monthlyLimit               Int       @default(0)
  dailyLimit                 Int       @default(0)
  premiumTokensTotal         Int       @default(0)
  premiumTokensUsed          Int       @default(0)
  premiumTokensRemaining     Int       @default(0)
  bonusTokensTotal           Int       @default(0)
  bonusTokensUsed            Int       @default(0)
  bonusTokensRemaining       Int       @default(0)
  dailyTokenLimit            Int       @default(0)
  dailyTokensUsed            Int       @default(0)
  dailyTokensRemaining       Int       @default(0)
  rolledOverTokens           Int       @default(0)
  totalAvailableToday        Int       @default(0)
  cycleStartDate             DateTime
  cycleEndDate               DateTime
  lastUsedAt                 DateTime?
  lastDailyReset             DateTime  @default(now())
  lastMonthlyReset           DateTime  @default(now())
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt
  lastVoiceUsedAt            DateTime?
  voiceMinutesUsed           Float     @default(0)
  voiceRequestCount          Int       @default(0)
  voiceHourlyResetAt         DateTime?
  voiceRequestsThisHour      Int       @default(0)
  voiceSecondsInput          Float     @default(0)
  voiceSecondsOutput         Float     @default(0)
  voiceUsageResetAt          DateTime?
  voiceActualCostThisMonth   Float     @default(0)
  voiceBonusMinutesEarned    Float     @default(0)
  voiceBonusMinutesUsed      Float     @default(0)
  voiceSavingsAccumulated    Float     @default(0)
  voiceTotalSavingsThisMonth Float     @default(0)
  promptPoolLimit            Int?      @default(100000)
  promptPoolUsed             Int?      @default(0)
  user                       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastDailyReset])
  @@index([cycleEndDate])
}

model Booster {
  id                String          @id @default(uuid())
  userId            String
  boosterType       String
  boosterPrice      Int
  status            String          @default("active")
  activatedAt       DateTime        @default(now())
  expiresAt         DateTime
  wordsUsed         Int             @default(0)
  paymentGateway    String?
  gatewayPaymentId  String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  cooldownEnd       DateTime?
  boosterName       String
  cooldownDuration  Int?            @default(0)
  creditsAdded      Int?
  creditsRemaining  Int?
  creditsUsed       Int             @default(0)
  description       String?
  gatewayMetadata   Json?
  gatewayOrderId    String?         @unique
  planName          String
  validity          Int?            @default(10)
  wordsAdded        Int?
  wordsRemaining    Int?
  wordsUnlocked     Int?
  distributionLogic String?
  docsBonus         Int?
  maxPerPlanPeriod  Int?            @default(2)
  priceMultiplier   Float?
  purchaseNumber    Int?
  resetOn           String?         @default("plan_renewal")
  boosterCategory   BoosterCategory
  currency          Currency        @default(INR)
  region            Region          @default(IN)
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([boosterCategory])
  @@index([status])
  @@index([expiresAt])
  @@index([planName])
  @@index([purchaseNumber])
  @@index([currency])
  @@index([region])
  @@map("boosters")
}



model Transaction {
  id               String   @id @default(uuid())
  userId           String
  type             String
  amount           Int
  currency         String   @default("INR")
  status           String
  planName         String?
  boosterType      String?
  creditsAdded     Int?
  paymentGateway   String?
  gatewayPaymentId String?  @unique
  gatewayOrderId   String?
  gatewaySignature String?
  gatewayMetadata  Json?
  description      String?
  receiptUrl       String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  refundReason     String?
  region           Region   @default(IN)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([gatewayPaymentId])
  @@index([currency])
  @@map("transactions")
}

model ChatSession {
  id                        String                     @id @default(uuid())
  userId                    String
  title                     String                     @default("New Chat")
  aiModel                   String                     @default("claude-sonnet-4")
  brainMode                 String?
  messageCount              Int                        @default(0)
  totalTokens               Int                        @default(0)
  isActive                  Boolean                    @default(true)
  isPinned                  Boolean                    @default(false)
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  lastMessageAt             DateTime                   @default(now())
  isArchived                Boolean                    @default(false)
  personality               String?
  sessionAgeGroup           AgeGroup                   @default(NOT_SPECIFIED)
  sessionGender             Gender                     @default(NOT_SPECIFIED)
  sessionName               String?                    @default("User")
  user                      User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages                  Message[]
  personalizationSuggestion PersonalizationSuggestion?

  @@index([userId])
  @@index([isActive])
  @@index([isPinned])
  @@index([isArchived])
  @@index([lastMessageAt])
  @@index([personality])
  @@index([sessionGender])
  @@index([sessionAgeGroup])
  @@map("chat_sessions")
}

model Message {
  id                String      @id @default(uuid())
  userId            String
  sessionId         String
  role              String
  content           String
  aiModel           String?
  tokens            Int?
  hasAttachments    Boolean     @default(false)
  attachmentIds     String[]
  rating            Int?
  feedback          String?
  createdAt         DateTime    @default(now())
  isDocumentRequest Boolean     @default(false)
  wordsUsed         Int?
  branchId          String?
  parentMessageId   String?
  metadata          Json?
  aiProvider        String?
  encryptedContent  String?
  encryptionAuthTag String?
  encryptionIV      String?
  session           ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@index([branchId])
  @@index([parentMessageId])
  @@index([aiProvider])
  @@map("messages")
}



model FileUpload {
  id              String    @id @default(uuid())
  userId          String
  filename        String
  originalName    String
  mimeType        String
  fileSize        Int
  storageProvider String    @default("cloudinary")
  storageUrl      String
  storageKey      String?
  thumbnailUrl    String?
  width           Int?
  height          Int?
  duration        Int?
  category        String
  purpose         String?
  isPublic        Boolean   @default(false)
  isProcessed     Boolean   @default(true)
  createdAt       DateTime  @default(now())
  expiresAt       DateTime?
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
  @@index([purpose])
  @@index([createdAt])
  @@map("file_uploads")
}

model UsageAudit {
  id            String   @id @default(uuid())
  userId        String
  actionType    String
  category      String
  wordsUsed     Int?
  creditsUsed   Int?
  planName      String
  sessionId     String?
  messageId     String?
  jobId         String?
  metadata      Json?
  deductedFrom  String?
  balanceBefore Int?
  balanceAfter  Int?
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([actionType])
  @@index([category])
  @@index([planName])
  @@index([createdAt])
  @@map("usage_audits")
}

model SecurityPattern {
  id             String    @id @default(uuid())
  name           String    @unique
  pattern        String
  category       String
  severity       String
  action         String    @default("BLOCK")
  description    String
  examples       String[]
  falsePositives String[]
  isActive       Boolean   @default(true)
  priority       Int       @default(100)
  matchCount     Int       @default(0)
  blockCount     Int       @default(0)
  lastMatched    DateTime?
  version        Int       @default(1)
  createdBy      String?
  updatedBy      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([category])
  @@index([severity])
  @@index([isActive])
  @@index([priority])
  @@map("security_patterns")
}

model SecurityConfig {
  id            String    @id @default(uuid())
  configKey     String    @unique
  configValue   String
  dataType      String
  description   String
  category      String
  minValue      Float?
  maxValue      Float?
  allowedValues String[]
  isActive      Boolean   @default(true)
  isEditable    Boolean   @default(true)
  previousValue String?
  changedBy     String?
  changedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([configKey])
  @@index([category])
  @@index([isActive])
  @@map("security_configs")
}

model BlockedModelName {
  id             String    @id @default(uuid())
  modelName      String    @unique
  aliases        String[]
  provider       String?
  blockType      String    @default("REMOVE")
  replacement    String?   @default("Soriva")
  isActive       Boolean   @default(true)
  priority       Int       @default(100)
  detectionCount Int       @default(0)
  lastDetected   DateTime?
  reason         String?
  addedBy        String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([modelName])
  @@index([provider])
  @@index([isActive])
  @@map("blocked_model_names")
}

model ProviderConfiguration {
  id                   String    @id @default(uuid())
  providerName         String    @unique
  displayName          String
  isEnabled            Boolean   @default(true)
  priority             Int       @default(100)
  modelsConfig         Json
  baseUrl              String?
  apiVersion           String?
  timeout              Int?      @default(30000)
  retryAttempts        Int?      @default(3)
  supportsStreaming    Boolean   @default(false)
  supportsImages       Boolean   @default(false)
  supportsAudio        Boolean   @default(false)
  maxRequestsPerMinute Int?
  maxTokensPerRequest  Int?
  isHealthy            Boolean   @default(true)
  lastHealthCheck      DateTime?
  healthCheckUrl       String?
  configuredBy         String?
  notes                String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([providerName])
  @@index([isEnabled])
  @@index([priority])
  @@map("provider_configurations")
}

model SecurityLog {
  id                  String    @id @default(uuid())
  userId              String?
  ipAddress           String
  userAgent           String?
  requestPath         String?
  requestMethod       String?
  threatType          String
  severity            String
  riskScore           Int       @default(0)
  matchedPatterns     String[]
  detectionMethod     String[]
  userInput           String
  sanitizedInput      String?
  wasBlocked          Boolean   @default(false)
  blockReason         String?
  aiResponse          String?
  sessionId           String?
  conversationContext Json?
  flags               Json?
  reviewStatus        String    @default("pending")
  reviewedBy          String?
  reviewedAt          DateTime?
  reviewNotes         String?
  createdAt           DateTime  @default(now())
  user                User?     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([threatType])
  @@index([severity])
  @@index([riskScore])
  @@index([wasBlocked])
  @@index([reviewStatus])
  @@index([createdAt])
  @@map("security_logs")
}

model Document {
  id              String               @id @default(uuid())
  userId          String
  filename        String
  originalName    String
  fileType        String
  fileSize        Int
  mimeType        String
  storageUrl      String
  storageProvider String               @default("cloudinary")
  storageKey      String?
  textContent     String?
  contentLanguage String?              @default("en")
  wordCount       Int?
  pageCount       Int?
  metadata        Json?
  title           String?
  description     String?
  tags            String[]             @default([])
  status          String               @default("pending")
  processingStage String?
  errorMessage    String?
  chunkingMethod  String               @default("fixed")
  chunkSize       Int                  @default(512)
  chunkOverlap    Int                  @default(50)
  embeddingModel  String               @default("text-embedding-3-small")
  totalChunks     Int                  @default(0)
  totalEmbeddings Int                  @default(0)
  ragDocumentId   String?
  visibility      String               @default("private")
  sharedWith      String[]             @default([])
  processingTime  Int?
  indexingTime    Int?
  lastAccessedAt  DateTime?
  accessCount     Int                  @default(0)
  uploadedAt      DateTime             @default(now())
  processedAt     DateTime?
  indexedAt       DateTime?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  expiresAt       DateTime?
  chunks          DocumentChunk[]
  embeddings      DocumentEmbedding[]
  operations      DocumentOperation[]  @relation("DocumentOperations")
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  queryLogs       QueryLog[]
  creditLogs      SmartDocsCreditLog[]

  @@index([userId])
  @@index([status])
  @@index([fileType])
  @@index([visibility])
  @@index([uploadedAt])
  @@index([lastAccessedAt])
  @@map("documents")
}

model DocumentChunk {
  id            String             @id @default(uuid())
  documentId    String
  userId        String
  chunkIndex    Int
  content       String
  tokenCount    Int
  wordCount     Int
  charCount     Int
  startPosition Int?
  endPosition   Int?
  pageNumber    Int?
  section       String?
  metadata      Json?
  semanticGroup String?
  hasEmbedding  Boolean            @default(false)
  embeddingId   String?            @unique
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  document      Document           @relation(fields: [documentId], references: [id], onDelete: Cascade)
  embedding     DocumentEmbedding? @relation(fields: [embeddingId], references: [id])
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentId, chunkIndex])
  @@index([documentId])
  @@index([userId])
  @@index([chunkIndex])
  @@index([hasEmbedding])
  @@map("document_chunks")
}

model DocumentEmbedding {
  id             String         @id @default(uuid())
  documentId     String
  chunkId        String         @unique
  userId         String
  embedding      Json
  dimensions     Int
  model          String
  provider       String         @default("openai")
  metadata       Json?
  generationTime Int?
  status         String         @default("active")
  createdAt      DateTime       @default(now())
  lastUsedAt     DateTime?
  chunk          DocumentChunk?
  document       Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([userId])
  @@index([model])
  @@index([status])
  @@map("document_embeddings")
}

model QueryLog {
  id              String    @id @default(uuid())
  userId          String?
  documentId      String?
  query           String
  queryType       String    @default("semantic")
  queryTokens     Int?
  queryWords      Int?
  language        String?   @default("en")
  topK            Int       @default(5)
  threshold       Float?
  filters         Json?
  resultsFound    Int       @default(0)
  resultsReturned Int       @default(0)
  resultChunkIds  String[]  @default([])
  retrievalTime   Int?
  embeddingTime   Int?
  searchTime      Int?
  topScores       Float[]   @default([])
  avgScore        Float?
  wasHelpful      Boolean?
  feedbackRating  Int?
  feedbackComment String?
  sessionId       String?
  messageId       String?
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime  @default(now())
  document        Document? @relation(fields: [documentId], references: [id])
  user            User?     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([documentId])
  @@index([queryType])
  @@index([createdAt])
  @@index([sessionId])
  @@map("query_logs")
}

model RAGConfiguration {
  id            String    @id @default(uuid())
  configKey     String    @unique
  configValue   String
  dataType      String
  scope         String    @default("global")
  scopeId       String?
  category      String
  description   String
  minValue      Float?
  maxValue      Float?
  allowedValues String[]
  isActive      Boolean   @default(true)
  isEditable    Boolean   @default(true)
  previousValue String?
  changedBy     String?
  changedAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([configKey])
  @@index([category])
  @@index([scope])
  @@index([isActive])
  @@map("rag_configurations")
}

model LearnedPattern {
  id                  String    @id @default(uuid())
  pattern             String
  patternType         String
  frequency           Int       @default(1)
  uniqueUsers         Int       @default(1)
  successRate         Float     @default(0.0)
  riskScore           Int       @default(0)
  threatLevel         String    @default("UNKNOWN")
  firstSeenAt         DateTime  @default(now())
  lastSeenAt          DateTime  @default(now())
  sourceLogIds        String[]
  status              String    @default("ANALYZING")
  confidence          Float     @default(0.0)
  promotedToPatternId String?
  promotedAt          DateTime?
  promotedBy          String?
  examples            String[]
  context             Json?
  reviewStatus        String    @default("pending")
  reviewedBy          String?
  reviewNotes         String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([patternType])
  @@index([frequency])
  @@index([riskScore])
  @@index([status])
  @@index([reviewStatus])
  @@index([lastSeenAt])
  @@map("learned_patterns")
}

model ExportLog {
  id           String   @id @default(uuid())
  userId       String
  format       String
  messageCount Int
  fileSize     Int
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("export_logs")
}



model ConversationMessage {
  id             String   @id @default(cuid())
  userId         String
  conversationId String
  role           String
  content        String
  emotion        String?
  isImportant    Boolean  @default(false)
  metadata       String?
  timestamp      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, timestamp])
  @@index([conversationId])
  @@index([userId, isImportant])
  @@map("conversation_messages")
}

model PersonalizationSuggestion {
  id               String           @id @default(uuid())
  sessionId        String           @unique
  userId           String
  detectedGender   Gender?
  detectedAgeGroup AgeGroup?
  genderConfidence Float            @default(0)
  ageConfidence    Float            @default(0)
  status           SuggestionStatus @default(PENDING)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  expiresAt        DateTime?
  session          ChatSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([status])
  @@map("personalization_suggestions")
}

model DocumentOperation {
  id             String          @id @default(uuid())
  documentId     String
  userId         String
  operationType  OperationType
  operationName  String
  category       String          @default("general")
  inputTokens    Int             @default(0)
  outputTokens   Int             @default(0)
  totalTokens    Int             @default(0)
  cost           Float           @default(0)
  aiProvider     String?
  aiModel        String?
  result         String?
  resultPreview  String?
  status         OperationStatus @default(SUCCESS)
  error          String?
  processingTime Int?
  retryCount     Int             @default(0)
  cacheKey       String?
  fromCache      Boolean         @default(false)
  cacheHit       Boolean         @default(false)
  metadata       Json?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  document       Document        @relation("DocumentOperations", fields: [documentId], references: [id], onDelete: Cascade)
  user           User            @relation("UserDocumentOperations", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([documentId])
  @@index([operationType])
  @@index([category])
  @@index([createdAt])
  @@index([cacheKey])
  @@map("document_operations")
}

model DocumentUsage {
  id                  String   @id @default(uuid())
  userId              String   @unique
  documentsThisMonth  Int      @default(0)
  operationsThisMonth Int      @default(0)
  tokensUsedThisMonth Int      @default(0)
  costThisMonth       Float    @default(0)
  freeOpsThisMonth    Int      @default(0)
  paidOpsThisMonth    Int      @default(0)
  documentLimit       Int      @default(5)
  operationLimit      Int      @default(25)
  isPaidUser          Boolean  @default(false)
  totalStorageUsed    BigInt   @default(0)
  storageLimit        BigInt   @default(10485760)
  lastMonthlyReset    DateTime @default(now())
  cycleStartDate      DateTime @default(now())
  
  // OCR Usage - HYBRID v3.0
  ocrGoogleUsed    Int       @default(0)  // Google Vision (for images)
  ocrMistralUsed   Int       @default(0)  // Mistral OCR (for PDFs)
  lastResetDate    DateTime  @default(now())
  
  cycleEndDate        DateTime
  operationsThisHour  Int      @default(0)
  lastHourlyReset     DateTime @default(now())
  hourlyLimit         Int      @default(10)
  operationsToday     Int      @default(0)
  lastDailyReset      DateTime @default(now())
  metadata            Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation("UserDocumentUsage", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastMonthlyReset])
  @@index([isPaidUser])
  @@map("document_usage")
}

model Forge {
  id            String    @id @default(uuid())
  userId        String
  sessionId     String?
  messageId     String?
  title         String
  content       String
  contentType   ForgeType
  language      String?
  version       Int       @default(1)
  isPublic      Boolean   @default(false)
  shareToken    String?   @unique
  copyCount     Int       @default(0)
  downloadCount Int       @default(0)
  viewCount     Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  expiresAt     DateTime?
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([contentType])
  @@index([shareToken])
  @@index([createdAt])
  @@map("forges")
}



model WorkspaceFreeQuota {
  id                    String   @id @default(uuid())
  userId                String   @unique
  resumeUsesTotal       Int      @default(2)
  resumeUsesUsed        Int      @default(0)
  letterUsesTotal       Int      @default(2)
  letterUsesUsed        Int      @default(0)
  invoiceUsesTotal      Int      @default(3)
  invoiceUsesUsed       Int      @default(0)
  certificateUsesTotal  Int      @default(0)
  certificateUsesUsed   Int      @default(0)
  agreementUsesTotal    Int      @default(0)
  agreementUsesUsed     Int      @default(0)
  memoUsesTotal         Int      @default(0)
  memoUsesUsed          Int      @default(0)
  proposalUsesTotal     Int      @default(0)
  proposalUsesUsed      Int      @default(0)
  newsletterUsesTotal   Int      @default(0)
  newsletterUsesUsed    Int      @default(0)
  tokensUsed            Int      @default(0)
  lastResetAt           DateTime @default(now())
  subscriptionPlan      String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("workspace_free_quotas")
}

model WorkspaceGeneration {
  id                 String                @id @default(uuid())
  userId             String
  tool               WorkspaceTool
  toolSubType        String?
  toolName           String
  userInput          Json
  userPrompt         String?
  outputJson         Json?
  outputHtml         String?
  pdfUrl             String?
  docxUrl            String?
  pngUrl             String?
  inputTokens        Int                   @default(0)
  outputTokens       Int                   @default(0)
  totalTokens        Int                   @default(0)
  llmModel           String?
  llmProvider        String?
  estimatedCost      Float                 @default(0)
  status             WorkspaceStatus       @default(PENDING)
  errorMessage       String?
  processingTime     Int?
  isEdit             Boolean               @default(false)
  parentGenerationId String?
  editNumber         Int                   @default(0)
  templateUsed       String?
  version            Int                   @default(1)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  completedAt        DateTime?
  parentGeneration   WorkspaceGeneration?  @relation("GenerationEdits", fields: [parentGenerationId], references: [id])
  edits              WorkspaceGeneration[] @relation("GenerationEdits")
  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tool])
  @@index([status])
  @@index([parentGenerationId])
  @@map("workspace_generations")
}

model SmartDocsCredit {
  id                         String    @id @default(cuid())
  userId                     String    @unique
  planType                   PlanType  @default(STARTER)
  
  // Token-based system (replacing credits)
  monthlyTokens              Int       @default(100000)
  tokensUsedThisMonth        Int       @default(0)
  tokensUsedToday            Int       @default(0)
  bonusTokens                Int       @default(0)
  boosterTokens              Int       @default(0)
  
  // Legacy fields (kept for migration)
  monthlyCredits             Int       @default(0)
  creditsUsedThisMonth       Int       @default(0)
  creditsUsedToday           Int       @default(0)
  bonusCredits               Int       @default(0)
  carriedForwardCredits      Int       @default(0)
  
  cycleStartDate             DateTime  @default(now())
  cycleEndDate               DateTime
  lastDailyReset             DateTime  @default(now())
  lastMonthlyReset           DateTime  @default(now())
  boostersPurchasedThisMonth Int       @default(0)
  totalBoostersPurchased     Int       @default(0)
  totalTokensUsed            Int       @default(0)
  totalCreditsUsed           Int       @default(0)
  lastOperationAt            DateTime?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt
  user                       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("smart_docs_credits")
}

model SmartDocsCreditLog {
  id                 String    @id @default(cuid())
  userId             String
  operation          String
  operationName      String
  pageCount          Int       @default(1)
  tokensDeducted     Int       @default(0)
  inputTokens        Int       @default(0)
  outputTokens       Int       @default(0)
  bonusTokensUsed    Int       @default(0)
  boosterTokensUsed  Int       @default(0)
  monthlyTokensUsed  Int       @default(0)
  
  // Legacy fields (kept for migration)
  creditTier         Int       @default(0)
  creditsDeducted    Int       @default(0)
  bonusCreditsUsed   Int       @default(0)
  carriedCreditsUsed Int       @default(0)
  monthlyCreditsUsed Int       @default(0)
  
  documentId         String?
  aiProvider         String?
  aiModel            String?
  createdAt          DateTime  @default(now())
  document           Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([operation])
  @@map("smart_docs_credit_logs")
}

model SmartDocsBoosterPurchase {
  id            String   @id @default(cuid())
  userId        String
  boosterId     String
  boosterName   String
  tokensAdded   Int      @default(750000)
  creditsAdded  Int      @default(0)
  priceINR      Float
  priceUSD      Float
  validUntil    DateTime
  isExpired     Boolean  @default(false)
  isUsed        Boolean  @default(false)
  tokensUsed    Int      @default(0)
  paymentId     String?
  paymentStatus String?
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([isExpired])
  @@map("smart_docs_booster_purchases")
}

model ExchangeRate {
  id        String   @id @default(cuid())
  currency  String   @unique
  rate      Float
  updatedAt DateTime @updatedAt
}

model UserModelUsage {
  id          String   @id @default(cuid())
  userId      String
  modelId     String
  tokensUsed  Int      @default(0)
  tokensLimit Int      @default(0)
  periodType  String   @default("monthly")
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, modelId, periodType, periodStart])
  @@index([userId, periodStart])
  @@index([userId, modelId])
}

model ImageUsage {
  id                   String    @id @default(cuid())
  userId               String    @unique
  klein9bImagesUsed    Int       @default(0)
  klein9bImagesLimit   Int       @default(0)
  boosterKlein9bImages Int       @default(0)
  schnellImagesUsed    Int       @default(0)
  schnellImagesLimit   Int       @default(0)
    // Nano Banana (NEW)
  nanoBananaImagesLimit    Int      @default(0)
  nanoBananaImagesUsed     Int      @default(0)
  boosterNanoBananaImages  Int      @default(0)
  
  // Flux Kontext (NEW)
  fluxKontextImagesLimit   Int      @default(0)
  fluxKontextImagesUsed    Int      @default(0)
  boosterFluxKontextImages Int      @default(0)
  boosterSchnellImages Int       @default(0)
  totalImagesGenerated Int       @default(0)
  cycleStartDate       DateTime
  cycleEndDate         DateTime
  lastImageGeneratedAt DateTime?
  lastMonthlyReset     DateTime  @default(now())
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([cycleEndDate])
  @@map("image_usage")
}

model ImageGeneration {
  id              String   @id @default(cuid())
  userId          String
  provider        String
  prompt          String
  optimizedPrompt String?
  imageUrl        String?
  status          String   @default("pending")
  costINR         Float    @default(0)
  generationTime  Int?
  errorMessage    String?
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([provider])
  @@index([status])
  @@map("image_generations")
}

enum NewsCategory {
  entertainment
  sports
  technology
  business
  general
  science
  health
  politics
  world
  lifestyle
}



enum HealthPlan {
  FREE
  PERSONAL
  FAMILY
}

enum HealthSubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAUSED
}

enum ReportType {
  BLOOD_TEST
  XRAY
  MRI
  CT_SCAN
  ULTRASOUND
  ECG
  PRESCRIPTION
  DISCHARGE_SUMMARY
  OTHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
  NOT_SPECIFIED
}

enum AgeGroup {
  YOUNG
  MIDDLE
  SENIOR
  NOT_SPECIFIED
}

enum PlanType {
  STARTER
  LITE
  PLUS
  PRO
  APEX
  SOVEREIGN
}

enum PlanStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
  TRIAL
}

enum BoosterCategory {
  COOLDOWN
  ADDON
  DOC_AI
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SuggestionStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum SecurityStatus {
  TRUSTED
  FLAGGED
  BLOCKED
}

enum ActivityTrend {
  NEW
  INCREASING
  STABLE
  DECLINING
  IRREGULAR
}

enum Region {
  IN
  INTL
}

enum Currency {
  INR
  USD
}

enum OperationType {
  SUMMARY_SHORT
  SUMMARY_LONG
  SUMMARY_BULLET
  KEYWORD_EXTRACT
  DOCUMENT_CLEANUP
  TRANSLATE_BASIC
  FLASHCARDS
  TEST_GENERATOR
  NOTES_GENERATOR
  TOPIC_BREAKDOWN
  CROSS_PDF_COMPARE
  TABLE_TO_CHARTS
  SUMMARIES_ADVANCED
  INSIGHTS_EXTRACTION
  DOCUMENT_CLEANUP_ADVANCED
  KEYWORD_INDEX_EXTRACTOR
  WORKFLOW_CONVERSION
  PRESENTATION_MAKER
  QUESTION_BANK
  FILL_IN_BLANKS
  DOCUMENT_CHAT_MEMORY
  TRANSLATE_SIMPLIFY_ADVANCED
  DIAGRAM_INTERPRETATION
  TREND_ANALYSIS
  CONTRACT_LAW_SCAN
  MULTI_DOC_REASONING
  VOICE_MODE
  REPORT_BUILDER
  AI_DETECTION_REDACTION
  EXPLAIN_SIMPLE
  EXTRACT_DEFINITIONS
  //  NEW - Added Feb 2026 
  EXPLAIN_AS_TEACHER
  QUIZ_TURBO
  ELI5
}

enum OperationStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
  TIMEOUT
  CANCELLED
  CACHED
}

enum ForgeType {
  CODE
  DOCUMENT
  MARKDOWN
  HTML
  TABLE
  JSON
  CSV
  DIAGRAM
}

enum WorkspaceTool {
  RESUME
  LETTER
  INVOICE
  CERTIFICATE
  AGREEMENT
  MEMO
  PROPOSAL
  NEWSLETTER
}

enum WorkspaceStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
// ================================================
// MEMORY SYSTEM
// ================================================

model ConversationMemory {
  id               String    @id @default(cuid())
  userId           String
  conversationId   String
  
  // Layer 1: System Memory (persistent facts about user/context)
  systemMemory     Json      @default("{}")
  
  // Layer 2: Rolling Summary (compressed history)
  rollingSummary   String    @default("")
  summaryTokens    Int       @default(0)
  lastSummarizedAt DateTime?
  
  // Meta
  totalMessages    Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  rawMessages      RawMessage[]
  
  @@unique([userId, conversationId])
  @@index([userId])
}

model RawMessage {
  id               String   @id @default(cuid())
  memoryId         String
  role             String   // "user" | "assistant"
  content          String
  tokenCount       Int      @default(0)
  messageIndex     Int
  createdAt        DateTime @default(now())
  
  memory           ConversationMemory @relation(fields: [memoryId], references: [id], onDelete: Cascade)
  
  @@index([memoryId, messageIndex])
}
// ============================================
// CHATBOT API - Multi-Client Chatbot Service
// ============================================

model ChatbotClient {
  id                String   @id @default(cuid())
  slug              String   @unique // bluepeak, clientX, etc.
  name              String   // Blue Peak Realty
  apiKey            String   @unique @map("api_key")
  apiKeyHash        String   @map("api_key_hash")
  
  // LLM Configuration
  llmProvider       String   @default("gemini") @map("llm_provider")
  llmModel          String   @default("gemini-2.0-flash") @map("llm_model")
  systemPrompt      String?  @map("system_prompt") @db.Text
  temperature       Float    @default(0.7)
  maxTokensPerMsg   Int      @default(1024) @map("max_tokens_per_msg")
  
  // Message Limits
  dailyMessageLimit   Int    @default(500) @map("daily_message_limit")
  monthlyMessageLimit Int    @default(10000) @map("monthly_message_limit")
  
  // Token Limits
  monthlyInputTokens  Int    @default(2000000) @map("monthly_input_tokens")
  monthlyOutputTokens Int    @default(1000000) @map("monthly_output_tokens")
  
  // Session Limits
  dailySessionLimit   Int    @default(200) @map("daily_session_limit")
  
  // Lead Limits  
  monthlyLeadLimit    Int    @default(500) @map("monthly_lead_limit")
  
  // Usage Tracking (Current Month)
  usedInputTokens     Int    @default(0) @map("used_input_tokens")
  usedOutputTokens    Int    @default(0) @map("used_output_tokens")
  usedMessages        Int    @default(0) @map("used_messages")
  usageResetDate      DateTime @default(now()) @map("usage_reset_date")
  
  // Widget Config (JSON)
  widgetConfig      Json?    @map("widget_config")
  
  // Status
  isActive          Boolean  @default(true) @map("is_active")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  sessions          ChatbotSession[]
  leads             ChatbotLead[]
  flows             ChatbotFlow[]

  
  @@map("chatbot_clients")
}

model ChatbotSession {
  id            String   @id @default(cuid())
  clientId      String   @map("client_id")
  
  // Visitor Info
  visitorId     String   @map("visitor_id") // fingerprint/cookie based
  visitorIp     String?  @map("visitor_ip")
  userAgent     String?  @map("user_agent") @db.Text
  referrer      String?  @db.Text
  
  // Session State
  currentPage   String?  @map("current_page")
  isActive      Boolean  @default(true) @map("is_active")
  
  // Timestamps
  startedAt     DateTime @default(now()) @map("started_at")
  lastActiveAt  DateTime @default(now()) @map("last_active_at")
  endedAt       DateTime? @map("ended_at")
  
  // Relations
  client        ChatbotClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  messages      ChatbotMessage[]
  lead          ChatbotLead?
  
  @@index([clientId, visitorId])
  @@index([clientId, isActive])
  @@map("chatbot_sessions")
}

model ChatbotMessage {
  id            String   @id @default(cuid())
  sessionId     String   @map("session_id")
  
  // Message Content
  role          String   // 'user' | 'assistant' | 'system'
  content       String   @db.Text
  
  // AI Metadata
  model         String?  // which model responded
  promptTokens  Int?     @map("prompt_tokens")
  outputTokens  Int?     @map("output_tokens")
  latencyMs     Int?     @map("latency_ms")
  
  // Message Type
  messageType   String   @default("text") @map("message_type") // text, option_select, lead_form
  metadata      Json?    // buttons clicked, options shown, etc.
  
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  session       ChatbotSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId, createdAt])
  @@map("chatbot_messages")
}

model ChatbotLead {
  id            String   @id @default(cuid())
  clientId      String   @map("client_id")
  sessionId     String   @unique @map("session_id")
  
  // Lead Info
  name          String?
  email         String?
  phone         String?
  
  // Additional Data
  customFields  Json?    @map("custom_fields")
  
  // Lead Quality
  score         Int?     // AI-computed lead score
  source        String?  // which page/flow
  
  // Status
  status        String   @default("new") // new, contacted, qualified, converted
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Relations
  client        ChatbotClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  session       ChatbotSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([clientId, status])
  @@index([clientId, createdAt])
  @@map("chatbot_leads")
}
model ChatbotFlow {
  id          String   @id @default(cuid())
  clientId    String   @map("client_id")
  trigger     String   // "keyword" | "option_click" | "initial"
  keywords    String[] // ["billing", "bill", "invoice"]
  response    String?  @db.Text // Static response
  route       String?  // "/solutions/billing-ar"
  options     Json?    // Next options to show
  useAI       Boolean  @default(false) @map("use_ai")
  order       Int      @default(0)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Relation
  client      ChatbotClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  @@index([clientId, trigger])
  @@map("chatbot_flows")
}