const _0x3ef8af=_0x5f3c;(function(_0x1d3a31,_0x4df367){const _0x5bddf2=_0x5f3c,_0x973292=_0x1d3a31();while(!![]){try{const _0x3b8ebd=parseInt(_0x5bddf2(0x1c1))/0x1+-parseInt(_0x5bddf2(0x205))/0x2*(parseInt(_0x5bddf2(0x1cd))/0x3)+parseInt(_0x5bddf2(0x1d8))/0x4+parseInt(_0x5bddf2(0x1f2))/0x5+-parseInt(_0x5bddf2(0x1e7))/0x6+parseInt(_0x5bddf2(0x1d3))/0x7+-parseInt(_0x5bddf2(0x20c))/0x8;if(_0x3b8ebd===_0x4df367)break;else _0x973292['push'](_0x973292['shift']());}catch(_0x3f1cca){_0x973292['push'](_0x973292['shift']());}}}(_0x3897,0x60408));const _0x58f29a=(function(){let _0x59111e=!![];return function(_0x5ccbd3,_0x48995e){const _0x7be546=_0x59111e?function(){const _0x266a72=_0x5f3c;if(_0x48995e){const res=_0x48995e[_0x266a72(0x215)](_0x5ccbd3,arguments);return _0x48995e=null,res;}}:function(){};return _0x59111e=![],_0x7be546;};}()),_0x4a2d19=_0x58f29a(this,function(){const _0x327666=_0x5f3c;return _0x4a2d19[_0x327666(0x1f6)]()[_0x327666(0x1c7)](_0x327666(0x20e)+_0x327666(0x1e2))[_0x327666(0x1f6)]()[_0x327666(0x1dc)+_0x327666(0x1f8)](_0x4a2d19)[_0x327666(0x1c7)](_0x327666(0x20e)+_0x327666(0x1e2));});_0x4a2d19();'use strict';Object[_0x3ef8af(0x1ef)+_0x3ef8af(0x1d0)](exports,_0x3ef8af(0x20b)+'le',{'value':!![]}),exports[_0x3ef8af(0x213)+_0x3ef8af(0x216)]=exports['Workspac'+'eService']=void 0x0;function _0x3897(){const _0x26a641=['mJGZnJe1BgXzrNPW','tunPzvq','vhrqv2e','u3H6sM0','Dg9tDhjPBMC','yxrPB24','Dg9Y','y2XPzw50','Bw9KzwW','vw5RBM93BIa','r2vUzxjHDgK','CMf0Aw9UCW','zwrPDe91Dha','u1DbrwC','zMLN','zwrPDa','ufjpq0vtu0K','tM8GCxvVDge','zvn0yxr1CW','mtaZmZCWr091rvzl','C2uGChvYy2G','BgLZDeDLBMu','lY4Ul2nVBMy','D2vYifbHy2S','shrHruC','x19LC01Vzhu','mta1ndG5nNDvvujUEq','igvKAxrZige','kcGOlISPkYK','zNb1r1q','z2v0qMvZDfe','lI4VlI4VlI4','B3vUza','D29YA3nWywm','CLPnBeS','yxbWBhK','zvnLCNzPy2u','zw5Z','tuLuuW','B1zPqwO','q09nueXfveu','vev0thu','ve9ptfm','lI93B3jRC3a','zgvZyW','CgfJA0LK','Aw5WDxruB2S','CNzPy2u','BgXVD2vKiha','Bwf4rwrPDhm','v29YA3nWywm','BwvZC2fNzq','BM93','BM9Uzq','zxiGz2vUzxi','Aw9U','B24GBM90igy','DxnLCKLK','ywDL','zMLUze1HBNK','zMLUzfvUAxe','sNr2zNO','mZe4nJqWwg9UqxDh','D25er2G','ys5Zzxj2Awm','vNzND0e','C291CMnL','C2vYDMLJzq','C2vHCMnO','AwnL','ChjVDMLKzxi','DxnLCKLUChu','zgvKDwn0vxm','B3v0Chv0sNm','mtjkDu1Iy1G','DwfbzMG','t3v0Chv0','B3bLCNr5','rv9dt05gsuC','A2vUCW','mJm0otmZm21kEfDjvW','tLHHvui','v09ss1nqqum','y3jLyxrL','tM8GB3v0Chu','mJa0nJyZmKD3CgLKwq','DxbKyxrL','yxnLigeGug8','BguGzM9Yigu','y29UC3rYDwm','AwvUDa','z2vUzxjHDgu','qwj2tLm','twf4Aw11Bsa','zuDLBMvYyxq','kYKRja','Dw90yq','zxjYB3i','Dcb0BYbLzgK','Dg9VBa','mJKZodC0mgHtwvHVva','zvf1B3rHu2u','Dg90ywXuB2S','z2v0r2vUzxi','u3rHDhvZ','AfjQsK0','v0zZCKu','rKfjteve','zgvMAw5Luhi','rKH3B3y','z2v0vxnLCLC'];_0x3897=function(){return _0x26a641;};return _0x3897();}const client_1=require('@prisma/'+_0x3ef8af(0x1f9)),workspace_config_1=require(_0x3ef8af(0x211)+_0x3ef8af(0x208)+'ig/works'+'pace.con'+_0x3ef8af(0x200)),workspace_llm_service_1=require('./worksp'+'ace-llm.'+_0x3ef8af(0x1c6)),workspace_quota_service_1=require(_0x3ef8af(0x1ae)+'ace-quot'+_0x3ef8af(0x1c3)+'e'),prisma=new client_1['PrismaCl'+(_0x3ef8af(0x1dd))]();class WorkspaceService{async[_0x3ef8af(0x1de)](_0x3cd50f,_0xf27b1b,_0x5e0bff){const _0x7f1cea=_0x3ef8af,_0x331ea8={'SWAEg':_0x7f1cea(0x1b8),'HtaEG':function(_0x11615a,_0x78cd60){return _0x11615a===_0x78cd60;},'rZMlK':'DvnlE','SxzJm':function(_0x2ad1f6,_0x6a2dea){return _0x2ad1f6-_0x6a2dea;},'FHwov':function(_0x3c8f2c,_0x10164e){return _0x3c8f2c instanceof _0x10164e;}},_0x22f59b=await workspace_quota_service_1[_0x7f1cea(0x213)+_0x7f1cea(0x1e8)+_0x7f1cea(0x1b2)][_0x7f1cea(0x210)+_0x7f1cea(0x1e3)](_0x3cd50f,_0xf27b1b);if(_0x22f59b[_0x7f1cea(0x1c5)]===_0x331ea8[_0x7f1cea(0x1ff)])throw new Error(_0x7f1cea(0x203)+'\x20availab'+'le.\x20Plea'+_0x7f1cea(0x206)+_0x7f1cea(0x1da)+_0x7f1cea(0x209)+'.');const _0x19572f=await prisma['workspac'+_0x7f1cea(0x1e1)+'ion']['create']({'data':{'userId':_0x3cd50f,'tool':_0xf27b1b,'toolName':workspace_config_1[_0x7f1cea(0x1d5)+'E_CONFIG'][_0x7f1cea(0x1ad)][_0xf27b1b]['name'],'userInput':_0x5e0bff,'status':client_1[_0x7f1cea(0x1b5)+'eStatus'][_0x7f1cea(0x202)+'NG'],'powerPackId':_0x22f59b['packId']||null,'llmModel':_0x22f59b[_0x7f1cea(0x1fa)],'llmProvider':_0x22f59b[_0x7f1cea(0x1c9)]}});try{if(_0x331ea8[_0x7f1cea(0x20a)](_0x7f1cea(0x1ec),_0x331ea8[_0x7f1cea(0x214)])){const _0x160a07=_0x3c16f7?function(){if(_0x5e1d64){const res=_0x37437e['apply'](_0xfe6dcf,arguments);return _0x26c555=null,res;}}:function(){};return _0x570781=![],_0x160a07;}else{const _0x18ffe6=Date[_0x7f1cea(0x1b7)](),_0x852ad9=await workspace_llm_service_1[_0x7f1cea(0x213)+'eLLMServ'+'ice']['generate'+_0x7f1cea(0x1cf)](_0xf27b1b,_0x5e0bff,_0x22f59b['model'],_0x22f59b['provider']),_0x2ffe67=await prisma['workspac'+_0x7f1cea(0x1e1)+_0x7f1cea(0x1ba)][_0x7f1cea(0x1d9)]({'where':{'id':_0x19572f['id']},'data':{'outputJson':_0x852ad9['outputJs'+'on'],'inputTokens':_0x852ad9[_0x7f1cea(0x1b1)+_0x7f1cea(0x1a8)],'outputTokens':_0x852ad9['outputTo'+_0x7f1cea(0x1d2)],'totalTokens':_0x852ad9[_0x7f1cea(0x1e9)+'ens'],'status':client_1['Workspac'+_0x7f1cea(0x204)][_0x7f1cea(0x1ab)+'D'],'processingTime':_0x331ea8[_0x7f1cea(0x1f5)](Date['now'](),_0x18ffe6),'completedAt':new Date()}});return await workspace_quota_service_1[_0x7f1cea(0x213)+_0x7f1cea(0x1e8)+_0x7f1cea(0x1b2)][_0x7f1cea(0x1cb)+_0x7f1cea(0x1bd)](_0x3cd50f,_0xf27b1b,_0x22f59b[_0x7f1cea(0x1c5)],_0x22f59b[_0x7f1cea(0x1b0)],_0x852ad9[_0x7f1cea(0x1e9)+_0x7f1cea(0x1a8)]),{'success':!![],'generationId':_0x2ffe67['id'],'output':_0x852ad9[_0x7f1cea(0x1cc)+'on'],'tokensUsed':_0x852ad9[_0x7f1cea(0x1e9)+_0x7f1cea(0x1a8)],'quotaSource':_0x22f59b['source'],'remaining':_0x22f59b['remainin'+'g']-0x1};}}catch(_0x510268){await prisma['workspac'+_0x7f1cea(0x1e1)+_0x7f1cea(0x1ba)]['update']({'where':{'id':_0x19572f['id']},'data':{'status':client_1[_0x7f1cea(0x1b5)+'eStatus'][_0x7f1cea(0x1ee)],'errorMessage':_0x331ea8[_0x7f1cea(0x1f0)](_0x510268,Error)?_0x510268[_0x7f1cea(0x1b6)]:_0x7f1cea(0x1fb)+_0x7f1cea(0x1e4)}});throw _0x510268;}}async[_0x3ef8af(0x201)](_0x583164,_0x2e8ad3,_0x21f4ed){const _0x51f28d=_0x3ef8af,_0x367b09={'AbvNS':function(_0x55cc63,_0x5cab77){return _0x55cc63&&_0x5cab77;},'wnDGh':_0x51f28d(0x1af),'uaAfh':_0x51f28d(0x1d7)+_0x51f28d(0x1e5)+'t','MCieT':function(_0x4644f5,_0xe9102){return _0x4644f5>=_0xe9102;},'Jtvfz':_0x51f28d(0x1aa),'fpuGT':'none','VvgwA':_0x51f28d(0x1ac),'WFsrE':function(_0x1fcbe9,_0x3e5684){return _0x1fcbe9 instanceof _0x3e5684;},'NXaUB':_0x51f28d(0x1fb)+_0x51f28d(0x1e4)},_0x3ddb70=await prisma['workspac'+_0x51f28d(0x1e1)+_0x51f28d(0x1ba)][_0x51f28d(0x1bf)+'ue']({'where':{'id':_0x2e8ad3}});if(!_0x3ddb70||_0x3ddb70[_0x51f28d(0x1bc)]!==_0x583164)throw new Error(_0x51f28d(0x1fc)+_0x51f28d(0x1bb)+_0x51f28d(0x212));if(!_0x3ddb70[_0x51f28d(0x1cc)+'on'])throw new Error(_0x367b09['uaAfh']);const _0x3504ec=await prisma[_0x51f28d(0x213)+'eGenerat'+_0x51f28d(0x1ba)]['count']({'where':{'parentGenerationId':_0x2e8ad3}}),_0x261d15=workspace_config_1['WORKSPAC'+_0x51f28d(0x1d1)]['TOKEN_LI'+_0x51f28d(0x1a9)][_0x3ddb70['tool']][_0x51f28d(0x1b4)];if(_0x367b09[_0x51f28d(0x1f3)](_0x3504ec,_0x261d15)){if(_0x367b09[_0x51f28d(0x1c0)]===_0x51f28d(0x1f4))return prisma[_0x51f28d(0x213)+_0x51f28d(0x1e1)+_0x51f28d(0x1ba)]['findMany']({'where':{'userId':_0x19163d,..._0x367b09[_0x51f28d(0x1df)](_0x4ac691,{'tool':_0x2aae9d}),'isEdit':![]},'orderBy':{'createdAt':_0x367b09[_0x51f28d(0x1c2)]},'take':_0x1c32b2});else throw new Error(_0x51f28d(0x1e0)+_0x261d15+(_0x51f28d(0x20d)+_0x51f28d(0x1b3)+_0x51f28d(0x1b9)+_0x51f28d(0x1f7)));}const _0x465fb0=await workspace_quota_service_1['workspac'+_0x51f28d(0x1e8)+_0x51f28d(0x1b2)][_0x51f28d(0x210)+_0x51f28d(0x1e3)](_0x583164,_0x3ddb70['tool']);if(_0x465fb0[_0x51f28d(0x1c5)]===_0x367b09[_0x51f28d(0x20f)])throw new Error('No\x20quota'+'\x20availab'+_0x51f28d(0x1db)+'dit');const _0x5d1ba2=await prisma[_0x51f28d(0x213)+'eGenerat'+_0x51f28d(0x1ba)][_0x51f28d(0x1d6)]({'data':{'userId':_0x583164,'tool':_0x3ddb70[_0x51f28d(0x1e6)],'toolName':_0x3ddb70['toolName'],'userInput':_0x3ddb70[_0x51f28d(0x1ca)+'t'],'userPrompt':_0x21f4ed,'status':client_1[_0x51f28d(0x1b5)+'eStatus'][_0x51f28d(0x202)+'NG'],'powerPackId':_0x465fb0[_0x51f28d(0x1b0)]||null,'llmModel':_0x465fb0['model'],'llmProvider':_0x465fb0['provider'],'isEdit':!![],'parentGenerationId':_0x2e8ad3,'editNumber':_0x3504ec+0x1}});try{const _0x54c390=Date[_0x51f28d(0x1b7)](),_0x2096c1=await workspace_llm_service_1['workspac'+'eLLMServ'+_0x51f28d(0x1c8)][_0x51f28d(0x1fe)+'ut'](_0x3ddb70[_0x51f28d(0x1e6)],_0x3ddb70[_0x51f28d(0x1cc)+'on'],_0x21f4ed,_0x465fb0[_0x51f28d(0x1fa)],_0x465fb0[_0x51f28d(0x1c9)]),_0x266ff6=await prisma[_0x51f28d(0x213)+_0x51f28d(0x1e1)+'ion'][_0x51f28d(0x1d9)]({'where':{'id':_0x5d1ba2['id']},'data':{'outputJson':_0x2096c1['outputJs'+'on'],'inputTokens':_0x2096c1[_0x51f28d(0x1b1)+'ens'],'outputTokens':_0x2096c1['outputTo'+_0x51f28d(0x1d2)],'totalTokens':_0x2096c1[_0x51f28d(0x1e9)+_0x51f28d(0x1a8)],'status':client_1['Workspac'+_0x51f28d(0x204)][_0x51f28d(0x1ab)+'D'],'processingTime':Date[_0x51f28d(0x1b7)]()-_0x54c390,'completedAt':new Date()}});return await workspace_quota_service_1[_0x51f28d(0x213)+_0x51f28d(0x1e8)+_0x51f28d(0x1b2)][_0x51f28d(0x1cb)+_0x51f28d(0x1bd)](_0x583164,_0x3ddb70[_0x51f28d(0x1e6)],_0x465fb0[_0x51f28d(0x1c5)],_0x465fb0['packId'],_0x2096c1[_0x51f28d(0x1e9)+_0x51f28d(0x1a8)]),{'success':!![],'generationId':_0x266ff6['id'],'output':_0x2096c1[_0x51f28d(0x1cc)+'on'],'tokensUsed':_0x2096c1[_0x51f28d(0x1e9)+'ens'],'editNumber':_0x3504ec+0x1,'editsRemaining':_0x261d15-_0x3504ec-0x1};}catch(_0x3fffe9){if(_0x367b09[_0x51f28d(0x1c4)]!==_0x51f28d(0x1ac))throw new _0x1533b1(_0x367b09[_0x51f28d(0x1ce)]);else{await prisma[_0x51f28d(0x213)+_0x51f28d(0x1e1)+_0x51f28d(0x1ba)]['update']({'where':{'id':_0x5d1ba2['id']},'data':{'status':client_1[_0x51f28d(0x1b5)+_0x51f28d(0x204)]['FAILED'],'errorMessage':_0x367b09[_0x51f28d(0x1ed)](_0x3fffe9,Error)?_0x3fffe9[_0x51f28d(0x1b6)]:_0x367b09[_0x51f28d(0x1d4)]}});throw _0x3fffe9;}}}async['getStatu'+'s'](_0x4b2618){const _0x5dd853=_0x3ef8af;return workspace_quota_service_1['workspac'+_0x5dd853(0x1e8)+_0x5dd853(0x1b2)][_0x5dd853(0x1f1)+'orkspace'+_0x5dd853(0x1eb)](_0x4b2618);}async[_0x3ef8af(0x1ea)+_0x3ef8af(0x1f7)](_0x24fa4d,_0x35f2c5){const _0x1fea50=_0x3ef8af,_0x50fc3d={'Svvbl':function(_0x19e2ea,_0x24104b){return _0x19e2ea!==_0x24104b;}},_0x4fa0be=await prisma[_0x1fea50(0x213)+_0x1fea50(0x1e1)+_0x1fea50(0x1ba)]['findUniq'+'ue']({'where':{'id':_0x35f2c5},'include':{'edits':!![]}});if(!_0x4fa0be||_0x50fc3d['Svvbl'](_0x4fa0be[_0x1fea50(0x1bc)],_0x24fa4d))throw new Error(_0x1fea50(0x1fc)+'on\x20not\x20f'+'ound');return _0x4fa0be;}async[_0x3ef8af(0x207)+_0x3ef8af(0x1fd)](_0x2baedc,_0x5a8676,_0x1a9e3b=0x14){const _0x138e14=_0x3ef8af,_0xe1c1e9={'dvurG':function(_0x3e6f85,_0x5ccc89){return _0x3e6f85&&_0x5ccc89;}};return prisma[_0x138e14(0x213)+_0x138e14(0x1e1)+_0x138e14(0x1ba)][_0x138e14(0x1be)]({'where':{'userId':_0x2baedc,..._0xe1c1e9['dvurG'](_0x5a8676,{'tool':_0x5a8676}),'isEdit':![]},'orderBy':{'createdAt':_0x138e14(0x1af)},'take':_0x1a9e3b});}}function _0x5f3c(_0x20fdd7,_0x5911f2){_0x20fdd7=_0x20fdd7-0x1a8;const _0x55ed4b=_0x3897();let _0x4a2d19=_0x55ed4b[_0x20fdd7];if(_0x5f3c['IcSBzB']===undefined){var _0x58f29a=function(_0x13cace){const _0x41d7b2='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x2d2506='',_0x4a7737='',_0xa51e6e=_0x2d2506+_0x58f29a;for(let _0x2cc0af=0x0,_0x45a303,_0x37e5bf,_0x197501=0x0;_0x37e5bf=_0x13cace['charAt'](_0x197501++);~_0x37e5bf&&(_0x45a303=_0x2cc0af%0x4?_0x45a303*0x40+_0x37e5bf:_0x37e5bf,_0x2cc0af++%0x4)?_0x2d2506+=_0xa51e6e['charCodeAt'](_0x197501+0xa)-0xa!==0x0?String['fromCharCode'](0xff&_0x45a303>>(-0x2*_0x2cc0af&0x6)):_0x2cc0af:0x0){_0x37e5bf=_0x41d7b2['indexOf'](_0x37e5bf);}for(let _0x15f105=0x0,_0x597d51=_0x2d2506['length'];_0x15f105<_0x597d51;_0x15f105++){_0x4a7737+='%'+('00'+_0x2d2506['charCodeAt'](_0x15f105)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x4a7737);};_0x5f3c['dAISXH']=_0x58f29a,_0x5f3c['SNnwpt']={},_0x5f3c['IcSBzB']=!![];}const _0x3897c3=_0x55ed4b[0x0],_0x5f3c8b=_0x20fdd7+_0x3897c3,_0xf99d28=_0x5f3c['SNnwpt'][_0x5f3c8b];if(!_0xf99d28){const _0x3c16f7=function(_0x554e5e){this['ieoJmA']=_0x554e5e,this['AuamMF']=[0x1,0x0,0x0],this['SWUWHD']=function(){return'newState';},this['XxFOVA']='\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*',this['wVJQNT']='[\x27|\x22].+[\x27|\x22];?\x20*}';};_0x3c16f7['prototype']['RwLPad']=function(){const _0x3eabab=new RegExp(this['XxFOVA']+this['wVJQNT']),_0x4018cd=_0x3eabab['test'](this['SWUWHD']['toString']())?--this['AuamMF'][0x1]:--this['AuamMF'][0x0];return this['lAkelw'](_0x4018cd);},_0x3c16f7['prototype']['lAkelw']=function(_0x252bf4){if(!Boolean(~_0x252bf4))return _0x252bf4;return this['SlQFku'](this['ieoJmA']);},_0x3c16f7['prototype']['SlQFku']=function(_0x570781){for(let _0x5e1d64=0x0,_0x34bab8=this['AuamMF']['length'];_0x5e1d64<_0x34bab8;_0x5e1d64++){this['AuamMF']['push'](Math['round'](Math['random']())),_0x34bab8=this['AuamMF']['length'];}return _0x570781(this['AuamMF'][0x0]);},new _0x3c16f7(_0x5f3c)['RwLPad'](),_0x4a2d19=_0x5f3c['dAISXH'](_0x4a2d19),_0x5f3c['SNnwpt'][_0x5f3c8b]=_0x4a2d19;}else _0x4a2d19=_0xf99d28;return _0x4a2d19;}exports['Workspac'+'eService']=WorkspaceService,exports[_0x3ef8af(0x213)+_0x3ef8af(0x216)]=new WorkspaceService();